# Makefile pour Biological Qubits Atlas v2.0
# Usage: make <target>

.PHONY: help install test fair dashboard harvest validate ml clean

# === AIDE ===
help:
	@echo "ğŸš€ Biological Qubits Atlas v2.0 - Commandes Disponibles"
	@echo ""
	@echo "ğŸ“¦ Installation:"
	@echo "  make install          Installation dÃ©pendances complÃ¨tes"
	@echo "  make install-minimal  Installation sans ML (plus rapide)"
	@echo ""
	@echo "âœ… Phase 1 - Quick Wins:"
	@echo "  make fair             GÃ©nÃ¨re mÃ©tadonnÃ©es FAIR"
	@echo "  make dashboard        GÃ©nÃ¨re dashboard interactif D3.js"
	@echo "  make validate         Validation in vivo"
	@echo ""
	@echo "ğŸ”¬ Phase 2 - Expansion:"
	@echo "  make harvest          Auto-extraction PubMed/FPbase"
	@echo "  make curate           Lance pipeline curation complÃ¨te"
	@echo ""
	@echo "ğŸ§  Phase 3 - ML:"
	@echo "  make ml-train         EntraÃ®ne modÃ¨le GNN"
	@echo "  make ml-predict       PrÃ©diction sur nouveaux candidats"
	@echo ""
	@echo "ğŸ§¹ Maintenance:"
	@echo "  make clean            Nettoie fichiers temporaires"
	@echo "  make test             Lance tests unitaires"
	@echo "  make lint             VÃ©rifie qualitÃ© code"
	@echo ""
	@echo "ğŸŒ DÃ©ploiement:"
	@echo "  make serve            Lance serveur web local"
	@echo "  make deploy           DÃ©ploie sur GitHub Pages"

# === INSTALLATION ===
install:
	@echo "ğŸ“¦ Installation dÃ©pendances complÃ¨tes..."
	pip install -r requirements_v2.0.txt
	@echo "âœ… Installation terminÃ©e!"

install-minimal:
	@echo "ğŸ“¦ Installation minimale (sans ML)..."
	pip install pandas numpy requests biopython PyYAML
	@echo "âœ… Installation minimale terminÃ©e!"

# === PHASE 1: QUICK WINS ===
fair:
	@echo "ğŸ… GÃ©nÃ©ration mÃ©tadonnÃ©es FAIR..."
	python scripts/fair/generate_fair_metadata.py
	@echo "âœ… MÃ©tadonnÃ©es FAIR gÃ©nÃ©rÃ©es dans metadata/fair/"

dashboard:
	@echo "ğŸ“Š GÃ©nÃ©ration dashboard interactif..."
	python scripts/web/generate_interactive_dashboard.py
	@echo "âœ… Dashboard gÃ©nÃ©rÃ©: index_v2_interactive.html"
	@echo "ğŸŒ Lancer avec: make serve"

validate:
	@echo "ğŸ”¬ Validation in vivo..."
	python scripts/qa/in_vivo_validator.py
	@echo "âœ… Rapport gÃ©nÃ©rÃ©: reports/IN_VIVO_VALIDATION.md"

# === PHASE 2: EXPANSION ===
harvest:
	@echo "ğŸ” Auto-extraction multi-sources..."
	@if [ -z "$$NCBI_API_KEY" ]; then \
		echo "âš ï¸  ATTENTION: NCBI_API_KEY non dÃ©finie!"; \
		echo "   Export: export NCBI_API_KEY='votre_cle'"; \
		exit 1; \
	fi
	python scripts/automation/auto_harvest_v2.py
	@echo "âœ… Candidats extraits: data/interim/auto_harvest_v2.csv"

curate: harvest validate
	@echo "ğŸ§ª Pipeline curation complet..."
	python qubits_linter.py data/interim/auto_harvest_v2.csv
	@echo "âœ… Curation terminÃ©e!"

# === PHASE 3: ML ===
ml-train:
	@echo "ğŸ§  EntraÃ®nement modÃ¨le GNN..."
	@if ! python -c "import torch" 2>/dev/null; then \
		echo "âŒ PyTorch non installÃ©!"; \
		echo "   Installation: pip install torch torch-geometric rdkit"; \
		exit 1; \
	fi
	python scripts/ml/predict_quantum_proxies.py
	@echo "âœ… ModÃ¨le entraÃ®nÃ©: models/quantum_proxy_gnn.pth"

ml-predict:
	@echo "ğŸ”® PrÃ©diction nouveaux candidats..."
	python scripts/ml/predict_quantum_proxies.py --mode predict
	@echo "âœ… PrÃ©dictions gÃ©nÃ©rÃ©es!"

# === MAINTENANCE ===
clean:
	@echo "ğŸ§¹ Nettoyage fichiers temporaires..."
	find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
	find . -type f -name "*.pyc" -delete
	find . -type f -name "*.pyo" -delete
	find . -type f -name ".DS_Store" -delete
	rm -rf .pytest_cache/
	@echo "âœ… Nettoyage terminÃ©!"

test:
	@echo "âœ… Lancement tests unitaires..."
	pytest tests/ -v --tb=short || echo "âš ï¸  Certains tests ont Ã©chouÃ©"

lint:
	@echo "ğŸ” VÃ©rification qualitÃ© code..."
	python qubits_linter.py
	@echo "âœ… Linting terminÃ©!"

# === DÃ‰PLOIEMENT ===
serve:
	@echo "ğŸŒ Lancement serveur web local..."
	@echo "   URL: http://localhost:8000/index_v2_interactive.html"
	@python -m http.server 8000

deploy:
	@echo "ğŸš€ DÃ©ploiement GitHub Pages..."
	@if [ ! -f "index_v2_interactive.html" ]; then \
		echo "âŒ Dashboard non gÃ©nÃ©rÃ©!"; \
		echo "   Lancer: make dashboard"; \
		exit 1; \
	fi
	cp index_v2_interactive.html index.html
	git add index.html metadata/ reports/
	git commit -m "feat(deploy): v2.0 dashboard + FAIR metadata"
	git push origin main
	@echo "âœ… DÃ©ployÃ© sur GitHub Pages!"

# === WORKFLOW COMPLET ===
phase1: fair dashboard validate
	@echo "âœ… Phase 1 terminÃ©e (Quick Wins)!"

phase2: harvest curate
	@echo "âœ… Phase 2 terminÃ©e (Expansion)!"

phase3: ml-train
	@echo "âœ… Phase 3 terminÃ©e (Innovation ML)!"

all: phase1 phase2 phase3
	@echo "ğŸ‰ Toutes les phases terminÃ©es!"
	@echo "ğŸŒ Lancer dashboard: make serve"

# === RAPPORTS ===
report:
	@echo "ğŸ“Š GÃ©nÃ©ration rapport mensuel..."
	@echo "Total systÃ¨mes: $$(wc -l < data/processed/atlas_fp_optical_v1_3.csv)"
	@echo "Avec contraste: $$(grep -v '^SystemID' data/processed/atlas_fp_optical_v1_3.csv | grep -c ',')"
	@echo "Familles: $$(cut -d',' -f3 data/processed/atlas_fp_optical_v1_3.csv | sort -u | wc -l)"


